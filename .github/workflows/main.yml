name: Deploy Full Stack (Matrix)
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, osamah4]
    if: github.event_name != 'pull_request'

    strategy:
      fail-fast: false
      matrix:
        include:
          - env: dev
            kubeconfig_secret: KUBE_CONFIG_DEV
          - env: staging
            kubeconfig_secret: KUBE_CONFIG_STAGING
          - env: prod
            kubeconfig_secret: KUBE_CONFIG_PROD

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build and push backend image
        run: |
          docker build -t my-backend:${{ matrix.env }} backend

      - name: Build and push frontend image
        run: |
          docker build -t my-frontend:${{ matrix.env }} frontend

      - name: Verify local images exist
        run: |
          if (-not (docker image inspect my-backend:${{ matrix.env }} 2>$null)) {
            Write-Error "Missing local image: my-backend:${{ matrix.env }}"
            exit 1
          }

          if (-not (docker image inspect my-frontend:${{ matrix.env }} 2>$null)) {
            Write-Error "Missing local image: my-frontend:${{ matrix.env }}"
            exit 1
          }

      - name: Install kustomize
        shell: pwsh
        run: |
          if (Get-Command kustomize -ErrorAction SilentlyContinue) {
            return
          }

          $chocoBin = Join-Path $env:ChocolateyInstall "bin\kustomize.exe"
          $chocoPath = "C:\ProgramData\chocolatey\lib\kustomize\tools\kustomize.exe"
          if (Test-Path $chocoBin) {
            $env:PATH = "$(Split-Path $chocoBin);$env:PATH"
            return
          }
          if (Test-Path $chocoPath) {
            $env:PATH = "$(Split-Path $chocoPath);$env:PATH"
            return
          }

          if (Get-Command choco -ErrorAction SilentlyContinue) {
            $installed = choco list --local-only --exact kustomize | Select-String -Pattern '^kustomize\s'
            if (-not $installed) {
              choco install kustomize -y
            }
          } elseif (Get-Command winget -ErrorAction SilentlyContinue) {
            winget install --id Kubernetes.kustomize --accept-package-agreements --accept-source-agreements
          } else {
            Write-Error "kustomize not found and no package manager available."
            exit 1
          }

          if (-not (Get-Command kustomize -ErrorAction SilentlyContinue)) {
            if (Test-Path $chocoBin) {
              $env:PATH = "$(Split-Path $chocoBin);$env:PATH"
            } elseif (Test-Path $chocoPath) {
              $env:PATH = "$(Split-Path $chocoPath);$env:PATH"
            }
          }

          if (-not (Get-Command kustomize -ErrorAction SilentlyContinue)) {
            Write-Error "kustomize install completed but executable not found."
            exit 1
          }

      - name: Install kubectl
        shell: pwsh
        run: |
          if (Get-Command kubectl -ErrorAction SilentlyContinue) {
            return
          }

          if (Get-Command choco -ErrorAction SilentlyContinue) {
            choco install kubernetes-cli -y --ignore-installed
            $exitCode = $LASTEXITCODE
            if ($exitCode -ne 0 -and -not (Get-Command kubectl -ErrorAction SilentlyContinue)) {
              exit $exitCode
            }
          } elseif (Get-Command winget -ErrorAction SilentlyContinue) {
            winget install --id Kubernetes.kubectl --accept-package-agreements --accept-source-agreements
          } else {
            Write-Error "kubectl not found and no package manager available."
            exit 1
          }

      - name: Use local kubeconfig
        shell: pwsh
        run: |
          $configPath = Join-Path $env:USERPROFILE ".kube\config"
          if (-not (Test-Path $configPath)) {
            Write-Error "Kubeconfig not found at $configPath"
            exit 1
          }
          "KUBECONFIG=$configPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Detect changed services
        id: changes
        run: |
          Write-Host "Checking git diff..."

          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $changedFiles = @('backend/force-deploy', 'frontend/force-deploy', 'manifests/force-deploy')
          } else {
            $before = "${{ github.event.before }}"
            $after = "${{ github.sha }}"

            if ([string]::IsNullOrWhiteSpace($before) -or $before -eq '0000000000000000000000000000000000000000') {
              $changedFiles = git diff --name-only "$after^" $after
            } else {
              $changedFiles = git diff --name-only $before $after
            }
          }

          $changedDb = $changedFiles | Where-Object { $_ -match '^manifests/(base|overlays/.*/overrides)/database.yaml$' }
          $changedBackendManifest = $changedFiles | Where-Object { $_ -match '^manifests/(base|overlays/.*/overrides)/backend.yaml$' }
          $changedFrontendManifest = $changedFiles | Where-Object { $_ -match '^manifests/(base|overlays/.*/overrides)/frontend.yaml$' }
          $changedBackendCode = $changedFiles | Where-Object { $_ -match '^backend/' }
          $changedFrontendCode = $changedFiles | Where-Object { $_ -match '^frontend/' }
          $changedAny = $changedFiles | Where-Object { $_ -match '^(manifests/|backend/|frontend/)' }

          $CHANGED_DB = @($changedDb).Count
          $CHANGED_BACKEND = @($changedBackendManifest + $changedBackendCode).Count
          $CHANGED_FRONTEND = @($changedFrontendManifest + $changedFrontendCode).Count
          $CHANGED_ANY = @($changedAny).Count

          "db=$CHANGED_DB" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "backend=$CHANGED_BACKEND" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "frontend=$CHANGED_FRONTEND" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "any=$CHANGED_ANY" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Deploy Namespace
        run: |
          kubectl apply -f manifests/base/namespace.yaml

      - name: Deploy Manifests
        run: |
          kustomize edit set image my-backend=my-backend:${{ matrix.env }}
          kustomize edit set image my-frontend=my-frontend:${{ matrix.env }}
          kubectl apply -k .
        working-directory: manifests/overlays/${{ matrix.env }}

      - name: Deploy Database
        run: |
          kubectl rollout status statefulset/database --namespace=database

      - name: Wait for DB readiness
        run: |
          kubectl wait --for=condition=ready pod -l app=database --namespace=database --timeout=300s

      - name: Deploy Backend
        if: steps.changes.outputs.backend != '0' || steps.changes.outputs.db != '0'
        run: |
          kubectl rollout status deployment/backend-deployment --namespace=backend

      - name: Deploy Frontend
        if: steps.changes.outputs.frontend != '0' || steps.changes.outputs.backend != '0'
        run: |
          kubectl rollout status deployment/frontend-deployment --namespace=frontend

